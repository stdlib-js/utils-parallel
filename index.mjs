// Copyright (c) 2022 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
/// <reference types="./index.d.ts" />
import r from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-string-array@esm/index.mjs";import e from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-function@esm/index.mjs";import n from"https://cdn.jsdelivr.net/gh/stdlib-js/error-tools-fmtprodmsg@esm/index.mjs";import t from"https://cdn.jsdelivr.net/gh/stdlib-js/process-cwd@esm/index.mjs";import s from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-copy@esm/index.mjs";import i from"https://cdn.jsdelivr.net/gh/stdlib-js/os-num-cpus@esm/index.mjs";import o from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-plain-object@esm/index.mjs";import d from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-has-own-property@esm/index.mjs";import c from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-integer@esm/index.mjs";import l from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-nonnegative-integer@esm/index.mjs";import u from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-boolean@esm/index.mjs";import f from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-string@esm/index.mjs";function p(r){if(r.__esModule)return r;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(r).forEach((function(n){var t=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(e,n,t.get?t:{enumerable:!0,get:function(){return r[n]}})})),e}function a(r,e){for(var n=0,t=r.length-1;t>=0;t--){var s=r[t];"."===s?r.splice(t,1):".."===s?(r.splice(t,1),n++):n&&(r.splice(t,1),n--)}if(e)for(;n--;n)r.unshift("..");return r}var m=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,h=function(r){return m.exec(r).slice(1)};function g(){for(var r="",e=!1,n=arguments.length-1;n>=-1&&!e;n--){var t=n>=0?arguments[n]:"/";if("string"!=typeof t)throw new TypeError("Arguments to path.resolve must be strings");t&&(r=t+"/"+r,e="/"===t.charAt(0))}return(e?"/":"")+(r=a(C(r.split("/"),(function(r){return!!r})),!e).join("/"))||"."}function v(r){var e=j(r),n="/"===_(r,-1);return(r=a(C(r.split("/"),(function(r){return!!r})),!e).join("/"))||e||(r="."),r&&n&&(r+="/"),(e?"/":"")+r}function j(r){return"/"===r.charAt(0)}function b(){var r=Array.prototype.slice.call(arguments,0);return v(C(r,(function(r,e){if("string"!=typeof r)throw new TypeError("Arguments to path.join must be strings");return r})).join("/"))}function w(r,e){function n(r){for(var e=0;e<r.length&&""===r[e];e++);for(var n=r.length-1;n>=0&&""===r[n];n--);return e>n?[]:r.slice(e,n-e+1)}r=g(r).substr(1),e=g(e).substr(1);for(var t=n(r.split("/")),s=n(e.split("/")),i=Math.min(t.length,s.length),o=i,d=0;d<i;d++)if(t[d]!==s[d]){o=d;break}var c=[];for(d=o;d<t.length;d++)c.push("..");return(c=c.concat(s.slice(o))).join("/")}function y(r){var e=h(r),n=e[0],t=e[1];return n||t?(t&&(t=t.substr(0,t.length-1)),n+t):"."}function x(r,e){var n=h(r)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n}function k(r){return h(r)[3]}var E={extname:k,basename:x,dirname:y,sep:"/",delimiter:":",relative:w,join:b,isAbsolute:j,normalize:v,resolve:g};function C(r,e){if(r.filter)return r.filter(e);for(var n=[],t=0;t<r.length;t++)e(r[t],t,r)&&n.push(r[t]);return n}var _="b"==="ab".substr(-1)?function(r,e,n){return r.substr(e,n)}:function(r,e,n){return e<0&&(e=r.length+e),r.substr(e,n)},T=p(Object.freeze({__proto__:null,resolve:g,normalize:v,isAbsolute:j,join:b,relative:w,sep:"/",delimiter:":",dirname:y,basename:x,extname:k,default:E})),O=i,A={};A.workers=O-1,A.concurrency=A.workers,A.cmd="node",A.ordered=!1,A.uid=null,A.gid=null,A.encoding="buffer",A.maxBuffer=209715200;var B=A,P=o,q=d,z=c.isPrimitive,S=l.isPrimitive,I=u.isPrimitive,M=f.isPrimitive,D=n;var J=function(r,e){return P(e)?q(e,"concurrency")&&(r.concurrency=e.concurrency,!z(r.concurrency))?new TypeError(D("0l83b","concurrency",r.concurrency)):q(e,"workers")&&(r.workers=e.workers,!z(r.workers))?new TypeError(D("0l83b","workers",r.workers)):q(e,"cmd")&&(r.cmd=e.cmd,!M(r.cmd))?new TypeError(D("0l82i","cmd",r.cmd)):q(e,"ordered")&&(r.ordered=e.ordered,!I(r.ordered))?new TypeError(D("0l830","ordered",r.ordered)):q(e,"uid")&&(r.uid=e.uid,!S(r.uid))?new TypeError(D("0l835","uid",r.uid)):q(e,"gid")&&(r.gid=e.gid,!S(r.gid))?new TypeError(D("0l835","gid",r.gid)):q(e,"maxBuffer")&&(r.maxBuffer=e.maxBuffer,!S(r.maxBuffer))?new TypeError(D("0l835","maxBuffer",r.maxBuffer)):null:new TypeError(D("0l82h",e))},N=require("child_process").fork,R=require("path"),X=require("debug"),Y=require("@stdlib/utils-keys"),Z=require("@stdlib/error-tools-fmtprodmsg"),$=require("./options.js"),F=X("parallel:exec"),G=R.resolve("/home/runner/work/utils-parallel/utils-parallel/lib/node","./worker/index.js");module.exports=function(r,e,n){var t,s,i,o,d,c,l,u,f,p,a;for(F("Options: %s.",JSON.stringify(e)),t=0,F("Creating %d workers...",e.workers),s={},d=[],o=$(e),a=0;a<e.workers;a++)F("Creating child process..."),(c=N(G,d,o)).on("error",w(c)),c.on("close",g(c)),c.on("exit",v(c)),c.on("disconnect",b(c)),c.on("message",h(c)),F("Child process created. pid: %d.",c.pid),s[c.pid]=c;for(l=Y(s),F("%d workers created.",l.length),F("Running %d scripts concurrently...",e.concurrency),i={},f=-1,a=0;a<e.concurrency;a++)u=l[a%l.length],m(s[u]);function m(e){var n;if((f+=1)>=r.length)return(n=Y(i).length)>0?void F("%d scripts are pending.",n):(F("All scripts have finished."),j());F("Instructing child process to run script: %s. pid: %d.",r[f],e.pid),e.send(r[f]),i[r[f]]=!0,F("%d of %d scripts have been processed.",f,r.length)}function h(r){return function(e){F("Child process message: %s. pid: %d.",e,r.pid),delete i[e],m(r)}}function g(r){return function(s,i){F("Child process closed. Code: %d. Signal: %s. pid: %d.",s,i,r.pid),y(s,i),F("%d of %d child processes have closed.",t+=1,e.workers),t===e.workers&&function(){if(p)return n(p);n()}()}}function v(r){return function(e,n){F("Child process exited. Code: %d. Signal: %s. pid: %d.",e,n,r.pid),y(e,n)}}function j(r){var e,n,t;for(r&&!p&&(p=r),F("Instructing child processes to close..."),e=Y(s),t=0;t<e.length;t++)n=e[t],F("Instructing child process (pid: %d) to close...",n),s[n].send("close")}function b(r){return function(){F("Child process disconnected. pid: %d.",r.pid)}}function w(r){return function(e){F("Child process error: %s. pid: %d.",e.message,r.pid),j(e)}}function y(r,e){var n;if(!p)return null!==r&&0!==r?n=new Error(Z("0l8CY",r)):null!==e&&(n=new Error(Z("0l8CZ",e))),n?(n.code=r,n.signal=e,j(n)):void 0}};var H=p(Object.freeze({__proto__:null})),K=T,L=r.primitives,Q=e,U=n,V=t,W=s,rr=B,er=J,nr=H;var tr=function(){var r,e,n,t,s,i;if(!L(r=arguments[0]))throw new TypeError(U("0l8CX",r));if(r=r.slice(),e=W(rr),arguments.length>2){if(n=arguments[2],t=er(e,arguments[1]))throw t}else n=arguments[1];if(!Q(n))throw new TypeError(U("0l82n",n));for(e.concurrency>r.length&&(e.concurrency=r.length),e.workers>e.concurrency&&(e.workers=e.concurrency),s=V(),i=0;i<r.length;i++)r[i]=K.resolve(s,r[i]);function o(r){if(r)return n(r);n()}nr(r,e,o)};export{tr as default};
//# sourceMappingURL=index.mjs.map
